name: Create PR from Branch

on:
  push:
    branches:
      - 'be/*'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Get Issue Number
        id: get_issue
        run: |
          echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV
          ISSUE_NUMBER=$(echo "${BRANCH_NAME}" | grep -oP '#\K\d+')
          echo "ISSUE_NUMBER=${ISSUE_NUMBER}" >> $GITHUB_ENV

      - name: Get Issue Details
        id: get_issue_details
        run: |
          ISSUE_DATA=$(gh issue view "${ISSUE_NUMBER}" --json title,body,assignees,labels --jq '{title: .title, body: .body, assignees: .assignees[].login, labels: .labels[].name}')
          echo "ISSUE_DATA=${ISSUE_DATA}" >> $GITHUB_ENV

      - name: Check for Existing PR
        id: check_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH="be/develop"
          HEAD_BRANCH="${{ env.BRANCH_NAME }}"
          EXISTING_PR=$(gh pr list --state open --base "${BASE_BRANCH}" --head "${HEAD_BRANCH}" --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "An existing PR #${EXISTING_PR} already exists for this issue and branch. Exiting..."
            exit 0
          fi

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSIGNEES=$(echo "${ISSUE_DATA}" | jq -r '.assignees | join(", ")')
          LABELS=$(echo "${ISSUE_DATA}" | jq -r '.labels | join(", ")')

          TEAM_MEMBERS=("unifolio0" "jongmee" "dwax1324" "jinchiim")
          
          IFS=', ' read -r -a ASSIGNEE_ARRAY <<< "${ASSIGNEES}"

          REVIEWERS=()
          for MEMBER in "${TEAM_MEMBERS[@]}"; do
            if [[ ! " ${ASSIGNEE_ARRAY[@]} " =~ " ${MEMBER} " ]]; then
              REVIEWERS+=("${MEMBER}")
            fi
          done

          REVIEWER_LIST=$(IFS=', '; echo "${REVIEWERS[*]}")

          ISSUE_TITLE=$(echo "${ISSUE_DATA}" | jq -r '.title')
          ISSUE_BODY=$(echo "${ISSUE_DATA}" | jq -r '.body')

          TASK_ITEMS=$(echo "${ISSUE_BODY}" | grep -oP '(?<=âœ¨ Task\n---\n)([\s\S]*?)(?=\nâœ¨ Time)')

          PR_BODY="## ğŸ„ PR í™•ì¸ ì‚¬í•­\n\nPRì´ ë‹¤ìŒ ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. :\n\n\- [ ] API ëª…ì„¸ì„œê°€ ì—…ë°ì´íŠ¸ í˜¹ì€ ì‘ì„±ì´ ë˜ì–´ ìˆë‚˜ìš”?\n\n## í˜„ì¬ ì‘ì—…ì€ ì–´ë–¤ ì´ìŠˆë¥¼ í•´ê²°í•œ ê²ƒì¸ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”.\n> Issue Number: #${ISSUE_NUMBER}\n\n\- ì´ìŠˆì— ìˆëŠ” íƒœìŠ¤í¬ ë“¤ì„ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.\n${TASK_ITEMS}\n\n## ê¸°ì¡´ ì½”ë“œì—ì„œ ë³€ê²½ëœ ì ì´ ìˆë‹¤ë©´ ì„¤ëª…í•´ì£¼ì„¸ìš”. (ì¶”ê°€ X)\n\n\- [ ] ìˆìŒ\n\- [ ] ì—†ìŒ\n"
          
          gh pr create --base "${BASE_BRANCH}" --head "${HEAD_BRANCH}" --title "${ISSUE_TITLE}" --body "${PR_BODY}" --assignee "${ASSIGNEES}" --reviewer "${REVIEWER_LIST}" --label "${LABELS}"
