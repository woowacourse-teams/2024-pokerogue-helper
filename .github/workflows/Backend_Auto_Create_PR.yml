name: Create PR from Branch

on:
  push:
    branches:
      - 'be/**'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Get Issue Number
        id: get_issue
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          ISSUE_NUMBER=$(echo "${BRANCH_NAME}" | grep -oP '#\K\d+')
          echo "ISSUE_NUMBER=${ISSUE_NUMBER}" >> $GITHUB_ENV

      - name: Get Issue Details
        id: get_issue_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_DATA=$(gh issue view "${ISSUE_NUMBER}" --json title,body,assignees,labels --jq '{title: .title, body: .body, assignees: [.assignees[].login], labels: [.labels[].name]}')
          echo "ISSUE_DATA=${ISSUE_DATA}" >> $GITHUB_ENV

      - name: Check for Existing PR
        id: check_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH="be/develop"
          echo "BASE_BRANCH=${BASE_BRANCH}" >> $GITHUB_ENV
          EXISTING_PR=$(gh pr list --state open --base "${BASE_BRANCH}" --head "${{ env.BRANCH_NAME }}" --json number --jq '.[0].number')
          echo "${EXISTING_PR} - print"

          if [ -n "$EXISTING_PR" ]; then
            echo "An existing PR #${EXISTING_PR} already exists for this issue and branch. Exiting..."
            echo "EXISTING_PR=true" >> $GITHUB_ENV
            exit 0
          else
            echo "EXISTING_PR=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.EXISTING_PR == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSIGNEES=$(echo "${ISSUE_DATA}" | jq -r '.assignees | join(", ")')
          echo "ASSIGNEES : ${ASSIGNEES} - print"
          LABELS=$(echo "${ISSUE_DATA}" | jq -r '.labels | join(", ")')
          echo "LABELS : ${LABELS} - print"

          TEAM_MEMBERS=("unifolio0" "jongmee" "dwax1324" "jinchiim")

          IFS=', ' read -r -a ASSIGNEE_ARRAY <<< "${ASSIGNEES}"

          REVIEWERS=()
          for MEMBER in "${TEAM_MEMBERS[@]}"; do
            if [[ ! " ${ASSIGNEE_ARRAY[@]} " =~ " ${MEMBER} " ]]; then
              REVIEWERS+=("${MEMBER}")
            fi
          done

          REVIEWER_LIST=$(IFS=', '; echo "${REVIEWERS[*]}")
          echo "REVIEWER_LIST : ${REVIEWER_LIST} - print"

          ISSUE_TITLE=$(echo "${ISSUE_DATA}" | jq -r '.title')
          echo "ISSUE_TITLE : ${ISSUE_TITLE} - print"
          ISSUE_BODY=$(echo "${ISSUE_DATA}" | jq -r '.body')
          echo "ISSUE_BODY : ${ISSUE_BODY} - print"

          TASK_ITEMS=$(echo "${ISSUE_BODY}" | awk '/‚ú® Task/,/‚ú® Time/' | sed '1d;$d')
          echo "TASK_ITEMS : ${TASK_ITEMS} - print"

          PR_BODY=$(cat <<EOM
          ## üçÑ PR ÌôïÏù∏ ÏÇ¨Ìï≠
          
          PRÏù¥ Îã§Ïùå ÏöîÍµ¨ ÏÇ¨Ìï≠ÏùÑ Ï∂©Ï°±ÌïòÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî. :
          
            - [ ] API Î™ÖÏÑ∏ÏÑúÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ ÌòπÏùÄ ÏûëÏÑ±Ïù¥ ÎêòÏñ¥ ÏûàÎÇòÏöî?
          
          ## ÌòÑÏû¨ ÏûëÏóÖÏùÄ Ïñ¥Îñ§ Ïù¥ÏäàÎ•º Ìï¥Í≤∞Ìïú Í≤ÉÏù∏ÏßÄ ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî.
            > Issue Number: #${ISSUE_NUMBER}
          
            ${TASK_ITEMS}
          
          ## Í∏∞Ï°¥ ÏΩîÎìúÏóêÏÑú Î≥ÄÍ≤ΩÎêú Ï†êÏù¥ ÏûàÎã§Î©¥ ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî. (Ï∂îÍ∞Ä X)
          
          - [ ] ÏûàÏùå
          - [ ] ÏóÜÏùå
          EOM
          )
          
          echo "PR_BODY : ${PR_BODY} - print"
          
          gh pr create --base "${{ env.BASE_BRANCH }}" --head "${{ env.BRANCH_NAME }}" --title "${ISSUE_TITLE}" --body "${PR_BODY}" --assignee "${ASSIGNEES}" --reviewer "${REVIEWER_LIST}" --label "${LABELS}"
